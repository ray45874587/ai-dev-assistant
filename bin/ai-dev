#!/usr/bin/env node

/**
 * AIå¼€å‘è¾…åŠ©ç³»ç»Ÿ - å‘½ä»¤è¡Œç•Œé¢
 * AI Development Assistant - Command Line Interface
 * Version: 1.0.1
 */

const fs = require('fs');
const path = require('path');
const AIDevAssistant = require('../src/ai-dev-assistant');

// é¢œè‰²å®šä¹‰
const colors = {
    reset: '\x1b[0m',
    red: '\x1b[31m',
    green: '\x1b[32m',
    yellow: '\x1b[33m',
    blue: '\x1b[34m',
    magenta: '\x1b[35m',
    cyan: '\x1b[36m',
    white: '\x1b[37m'
};

class AIDevCLI {
    constructor() {
        // æ£€æµ‹å½“å‰å·¥ä½œç›®å½•ï¼Œè€Œä¸æ˜¯å·¥å…·å®‰è£…ç›®å½•
        const workingDir = process.cwd();
        this.assistant = new AIDevAssistant(workingDir);
        this.commands = {
            'init': this.initCommand.bind(this),
            'status': this.statusCommand.bind(this),
            'update': this.updateCommand.bind(this),
            'analyze': this.analyzeCommand.bind(this),
            'docs': this.docsCommand.bind(this),
            'focus': this.focusCommand.bind(this),
            'audit': this.auditCommand.bind(this),
            'clean': this.cleanCommand.bind(this),
            'help': this.helpCommand.bind(this),
            '--version': this.versionCommand.bind(this),
            '-v': this.versionCommand.bind(this)
        };
    }

    /**
     * æ‰“å°å¸¦é¢œè‰²çš„æ¶ˆæ¯
     */
    print(message, color = 'white') {
        console.log(`${colors[color]}${message}${colors.reset}`);
    }

    /**
     * æ‰“å°æˆåŠŸæ¶ˆæ¯
     */
    success(message) {
        this.print(`âœ… ${message}`, 'green');
    }

    /**
     * æ‰“å°é”™è¯¯æ¶ˆæ¯
     */
    error(message) {
        this.print(`âŒ ${message}`, 'red');
    }

    /**
     * æ‰“å°è­¦å‘Šæ¶ˆæ¯
     */
    warning(message) {
        this.print(`âš ï¸ ${message}`, 'yellow');
    }

    /**
     * æ‰“å°ä¿¡æ¯æ¶ˆæ¯
     */
    info(message) {
        this.print(`â„¹ï¸ ${message}`, 'blue');
    }

    /**
     * æ‰“å°æ ‡é¢˜
     */
    printHeader() {
        console.log('');
        this.print('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'cyan');
        this.print('    ğŸ¤– AIå¼€å‘è¾…åŠ©ç³»ç»Ÿ (AI Development Assistant)', 'cyan');
        this.print('    Version: 1.0.0', 'cyan');
        this.print('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'cyan');
        console.log('');
    }

    /**
     * è¿è¡ŒCLI
     */
    async run() {
        const args = process.argv.slice(2);
        const command = args[0];
        const params = args.slice(1);

        if (!command || command === 'help') {
            this.printHeader();
            this.helpCommand();
            return;
        }

        if (this.commands[command]) {
            try {
                await this.commands[command](params);
            } catch (error) {
                this.error(`å‘½ä»¤æ‰§è¡Œå¤±è´¥: ${error.message}`);
                process.exit(1);
            }
        } else {
            this.error(`æœªçŸ¥å‘½ä»¤: ${command}`);
            this.info('ä½¿ç”¨ "ai-dev help" æŸ¥çœ‹å¯ç”¨å‘½ä»¤');
            process.exit(1);
        }
    }

    /**
     * åˆå§‹åŒ–å‘½ä»¤
     */
    async initCommand(params) {
        this.printHeader();
        this.info('åˆå§‹åŒ–AIå¼€å‘è¾…åŠ©ç³»ç»Ÿ...');
        
        try {
            const result = await this.assistant.initialize();
            
            if (result.success) {
                this.success('ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆï¼');
                console.log('');
                this.info('ç”Ÿæˆçš„æ–‡ä»¶:');
                console.log('  ğŸ“ .ai-dev-assistant/          # ç³»ç»Ÿç›®å½•');
                console.log('  ğŸ“ .ai-dev-assistant-rules.json # AIè§„åˆ™é…ç½®');
                console.log('  ğŸ“– .ai-instructions.md        # AIæŒ‡ä»¤æ–‡æ¡£');
                console.log('');
                this.info('é¡¹ç›®ä¿¡æ¯:');
                console.log(`  åç§°: ${result.config.name}`);
                console.log(`  ç±»å‹: ${result.config.type}`);
                console.log(`  è¯­è¨€: ${result.config.language}`);
                console.log('');
                this.info('ä¸‹ä¸€æ­¥:');
                console.log('  ai-dev status     # æŸ¥çœ‹ç³»ç»ŸçŠ¶æ€');
                console.log('  ai-dev analyze    # åˆ†æä»£ç è´¨é‡');
                console.log('  ai-dev docs       # ç”Ÿæˆæ–‡æ¡£');
            }
        } catch (error) {
            this.error(`åˆå§‹åŒ–å¤±è´¥: ${error.message}`);
            process.exit(1);
        }
    }

    /**
     * çŠ¶æ€å‘½ä»¤
     */
    async statusCommand(params) {
        try {
            const status = this.assistant.getStatus();
            
            console.log('');
            this.print('ğŸ¤– AIå¼€å‘è¾…åŠ©ç³»ç»ŸçŠ¶æ€', 'cyan');
            console.log('');
            
            // é¡¹ç›®ä¿¡æ¯
            this.print('ğŸ“Š é¡¹ç›®ä¿¡æ¯:', 'blue');
            console.log(`  åç§°: ${status.project.name}`);
            console.log(`  ç±»å‹: ${status.project.type}`);
            console.log(`  è¯­è¨€: ${status.project.language}`);
            console.log('');
            
            // ç³»ç»ŸçŠ¶æ€
            this.print('âš™ï¸ ç³»ç»ŸçŠ¶æ€:', 'blue');
            const healthColor = status.health === 'healthy' ? 'green' : 'yellow';
            this.print(`  å¥åº·çŠ¶æ€: ${status.health}`, healthColor);
            
            const checkMark = (condition) => condition ? 'âœ…' : 'âŒ';
            console.log(`  ${checkMark(status.system.initialized)} ç³»ç»Ÿå·²åˆå§‹åŒ–`);
            console.log(`  ${checkMark(status.system.configExists)} é…ç½®æ–‡ä»¶`);
            console.log(`  ${checkMark(status.system.rulesExists)} AIè§„åˆ™`);
            console.log(`  ${checkMark(status.system.contextExists)} ä¸Šä¸‹æ–‡æ•°æ®`);
            console.log('');
            
            // åŠŸèƒ½çŠ¶æ€
            this.print('ğŸ”§ åŠŸèƒ½çŠ¶æ€:', 'blue');
            Object.entries(status.features).forEach(([feature, enabled]) => {
                const status = enabled ? 'âœ… å¯ç”¨' : 'âŒ ç¦ç”¨';
                console.log(`  ${feature}: ${status}`);
            });
            
            // é—®é¢˜æŠ¥å‘Š
            if (status.issues && status.issues.length > 0) {
                console.log('');
                this.print('âš ï¸ å‘ç°çš„é—®é¢˜:', 'yellow');
                status.issues.forEach(issue => {
                    console.log(`  - ${issue}`);
                });
            }
            
            console.log('');
            
        } catch (error) {
            this.error(`è·å–çŠ¶æ€å¤±è´¥: ${error.message}`);
        }
    }

    /**
     * æ›´æ–°å‘½ä»¤
     */
    async updateCommand(params) {
        this.info('æ›´æ–°é¡¹ç›®ä¸Šä¸‹æ–‡...');
        
        try {
            const result = await this.assistant.update();
            
            if (result.success) {
                this.success('ä¸Šä¸‹æ–‡æ›´æ–°å®Œæˆï¼');
                
                if (result.changes && result.changes.length > 0) {
                    console.log('');
                    this.info('æ£€æµ‹åˆ°çš„å˜åŒ–:');
                    result.changes.forEach(change => {
                        console.log(`  - ${change.type}: ${change.message}`);
                    });
                }
            }
        } catch (error) {
            this.error(`æ›´æ–°å¤±è´¥: ${error.message}`);
        }
    }

    /**
     * åˆ†æå‘½ä»¤
     */
    async analyzeCommand(params) {
        const filePath = params[0];
        
        if (filePath) {
            this.info(`åˆ†ææ–‡ä»¶: ${filePath}`);
        } else {
            this.info('åˆ†ææ•´ä¸ªé¡¹ç›®...');
        }
        
        try {
            const result = await this.assistant.analyzeCode(filePath);
            
            if (filePath) {
                // å•æ–‡ä»¶åˆ†æç»“æœ
                console.log('');
                this.print(`ğŸ“„ æ–‡ä»¶åˆ†æç»“æœ: ${result.file}`, 'cyan');
                console.log('');
                
                this.print('ğŸ“Š æ–‡ä»¶æŒ‡æ ‡:', 'blue');
                console.log(`  è¡Œæ•°: ${result.metrics.lines}`);
                console.log(`  å¤§å°: ${result.metrics.size} å­—èŠ‚`);
                console.log(`  å¤æ‚åº¦: ${result.metrics.complexity}`);
                console.log('');
                
                if (result.violations.length > 0) {
                    this.print('âš ï¸ è§„åˆ™è¿å:', 'yellow');
                    result.violations.forEach(violation => {
                        const severityEmoji = violation.severity === 'error' ? 'ğŸš«' : 'âš ï¸';
                        console.log(`  ${severityEmoji} ${violation.description}`);
                    });
                    console.log('');
                }
                
                if (result.suggestions.length > 0) {
                    this.print('ğŸ’¡ æ”¹è¿›å»ºè®®:', 'green');
                    result.suggestions.forEach(suggestion => {
                        console.log(`  - ${suggestion.message}`);
                        if (suggestion.suggestion) {
                            console.log(`    å»ºè®®: ${suggestion.suggestion}`);
                        }
                    });
                }
            } else {
                // é¡¹ç›®åˆ†æç»“æœ
                console.log('');
                this.print('ğŸ“Š é¡¹ç›®åˆ†æå®Œæˆ', 'cyan');
                console.log('');
                
                this.print('ğŸ“ˆ ä»£ç æŒ‡æ ‡:', 'blue');
                console.log(`  æ€»æ–‡ä»¶æ•°: ${result.codeMetrics.totalFiles}`);
                console.log(`  ä»£ç è¡Œæ•°: ${result.codeMetrics.totalLines}`);
                console.log(`  å¤æ‚åº¦: ${result.codeMetrics.complexity}`);
                console.log('');
                
                this.print('ğŸ¯ è´¨é‡è¯„åˆ†:', 'blue');
                const scoreColor = result.quality.score >= 80 ? 'green' : 
                                 result.quality.score >= 60 ? 'yellow' : 'red';
                this.print(`  ${result.quality.score}/100`, scoreColor);
                
                if (result.quality.issues.length > 0) {
                    console.log('');
                    this.print('âš ï¸ å‘ç°çš„é—®é¢˜:', 'yellow');
                    result.quality.issues.forEach(issue => {
                        console.log(`  - ${issue}`);
                    });
                }
                
                console.log('');
                this.info('è¯¦ç»†æŠ¥å‘Šå·²ä¿å­˜åˆ°: .ai-dev-assistant/context/analysis-report.md');
            }
            
        } catch (error) {
            this.error(`åˆ†æå¤±è´¥: ${error.message}`);
        }
    }

    /**
     * æ–‡æ¡£å‘½ä»¤
     */
    async docsCommand(params) {
        this.info('ç”Ÿæˆé¡¹ç›®æ–‡æ¡£...');
        
        try {
            const result = await this.assistant.generateDocs();
            
            if (result.success) {
                this.success('æ–‡æ¡£ç”Ÿæˆå®Œæˆï¼');
                console.log('');
                this.info(`ğŸ“ æ–‡æ¡£ç›®å½•: ${result.docsDirectory}/`);
                console.log('');
                this.info('ç”Ÿæˆçš„æ–‡æ¡£:');
                result.files.forEach(file => {
                    console.log(`  ğŸ“„ ${file}`);
                });
                console.log('');
                this.info('ä½¿ç”¨è¯´æ˜:');
                console.log('  - æŸ¥çœ‹æ–‡æ¡£ç›®å½•è·å–å®Œæ•´é¡¹ç›®æ–‡æ¡£');
                console.log('  - README.md åŒ…å«é¡¹ç›®åŸºæœ¬ä¿¡æ¯');
                console.log(`  - ${result.docsDirectory}/ ç›®å½•åŒ…å«è¯¦ç»†çš„æŠ€æœ¯æ–‡æ¡£`);
                console.log('  - .ai-dev-instructions.md æ˜¯AIåŠ©æ‰‹çš„æŒ‡ä»¤æ–‡æ¡£');
            }
        } catch (error) {
            this.error(`æ–‡æ¡£ç”Ÿæˆå¤±è´¥: ${error.message}`);
        }
    }

    /**
     * ç„¦ç‚¹å‘½ä»¤
     */
    async focusCommand(params) {
        const area = params[0];
        
        if (!area) {
            this.error('è¯·æŒ‡å®šå¼€å‘ç„¦ç‚¹');
            this.info('å¯ç”¨ç„¦ç‚¹: performance, security, testing, refactoring, documentation');
            return;
        }
        
        try {
            const result = await this.assistant.setFocus(area);
            
            if (result.success) {
                this.success(`å¼€å‘ç„¦ç‚¹å·²è®¾ç½®ä¸º: ${area}`);
                console.log('');
                this.info('å½“å‰ä¼˜å…ˆçº§:');
                result.config.priorities.forEach((priority, index) => {
                    console.log(`  ${index + 1}. ${priority}`);
                });
            }
        } catch (error) {
            this.error(`è®¾ç½®ç„¦ç‚¹å¤±è´¥: ${error.message}`);
        }
    }

    /**
     * å®¡è®¡å‘½ä»¤
     */
    async auditCommand(params) {
        this.info('æ‰§è¡Œå®‰å…¨å®¡è®¡...');
        
        try {
            const result = await this.assistant.securityAudit();
            
            if (result.success) {
                this.success('å®‰å…¨å®¡è®¡å®Œæˆï¼');
                console.log('');
                
                if (result.issues.length > 0) {
                    this.print('ğŸš¨ å‘ç°çš„å®‰å…¨é—®é¢˜:', 'red');
                    result.issues.forEach(issue => {
                        const severityEmoji = issue.severity === 'high' ? 'ğŸš¨' : 'âš ï¸';
                        console.log(`  ${severityEmoji} ${issue.message}`);
                    });
                } else {
                    this.success('æœªå‘ç°ä¸¥é‡å®‰å…¨é—®é¢˜');
                }
                
                if (result.recommendations.length > 0) {
                    console.log('');
                    this.print('ğŸ”§ å®‰å…¨å»ºè®®:', 'blue');
                    result.recommendations.forEach(rec => {
                        console.log(`  - ${rec}`);
                    });
                }
                
                console.log('');
                this.info(`è¯¦ç»†æŠ¥å‘Š: ${result.reportPath}`);
            }
        } catch (error) {
            this.error(`å®‰å…¨å®¡è®¡å¤±è´¥: ${error.message}`);
        }
    }

    /**
     * æ¸…ç†å‘½ä»¤
     */
    async cleanCommand(params) {
        this.warning('è¿™å°†åˆ é™¤æ‰€æœ‰AIå¼€å‘è¾…åŠ©ç³»ç»Ÿæ–‡ä»¶');
        
        // ç®€å•ç¡®è®¤ï¼ˆåœ¨å®é™…é¡¹ç›®ä¸­å¯èƒ½éœ€è¦æ›´å¥½çš„ç¡®è®¤æœºåˆ¶ï¼‰
        try {
            const result = await this.assistant.cleanup();
            
            if (result.success) {
                this.success('ç³»ç»Ÿæ¸…ç†å®Œæˆ');
            }
        } catch (error) {
            this.error(`æ¸…ç†å¤±è´¥: ${error.message}`);
        }
    }

    /**
     * ç‰ˆæœ¬å‘½ä»¤
     */
    versionCommand(params) {
        console.log('1.0.0');
    }

    /**
     * å¸®åŠ©å‘½ä»¤
     */
    helpCommand(params) {
        console.log('');
        this.print('ğŸ¤– AIå¼€å‘è¾…åŠ©ç³»ç»Ÿ - å‘½ä»¤è¡Œå·¥å…·', 'cyan');
        console.log('');
        this.print('ä½¿ç”¨æ–¹æ³•:', 'blue');
        console.log('  ai-dev <command> [options]');
        console.log('');
        this.print('å‘½ä»¤:', 'blue');
        console.log('  init          åˆå§‹åŒ–AIå¼€å‘è¾…åŠ©ç³»ç»Ÿ');
        console.log('  status        æŸ¥çœ‹ç³»ç»ŸçŠ¶æ€');
        console.log('  update        æ›´æ–°é¡¹ç›®ä¸Šä¸‹æ–‡');
        console.log('  analyze [file] åˆ†æä»£ç è´¨é‡ï¼ˆå¯æŒ‡å®šæ–‡ä»¶ï¼‰');
        console.log('  docs          ç”Ÿæˆé¡¹ç›®æ–‡æ¡£');
        console.log('  focus <area>  è®¾ç½®å¼€å‘ç„¦ç‚¹');
        console.log('  audit         æ‰§è¡Œå®‰å…¨å®¡è®¡');
        console.log('  clean         æ¸…ç†ç³»ç»Ÿæ–‡ä»¶');
        console.log('  help          æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯');
        console.log('  --version/-v  æ˜¾ç¤ºç‰ˆæœ¬å·');
        console.log('');
        this.print('å¼€å‘ç„¦ç‚¹é€‰é¡¹:', 'blue');
        console.log('  performance   æ€§èƒ½ä¼˜åŒ–');
        console.log('  security      å®‰å…¨åŠ å›º');
        console.log('  testing       æµ‹è¯•è¦†ç›–');
        console.log('  refactoring   ä»£ç é‡æ„');
        console.log('  documentation æ–‡æ¡£å®Œå–„');
        console.log('');
        this.print('ç¤ºä¾‹:', 'blue');
        console.log('  ai-dev init                    # åˆå§‹åŒ–ç³»ç»Ÿ');
        console.log('  ai-dev status                  # æŸ¥çœ‹çŠ¶æ€');
        console.log('  ai-dev analyze src/index.js    # åˆ†æç‰¹å®šæ–‡ä»¶');
        console.log('  ai-dev focus performance       # è®¾ç½®æ€§èƒ½ç„¦ç‚¹');
        console.log('  ai-dev audit                   # å®‰å…¨å®¡è®¡');
        console.log('');
        this.print('æ›´å¤šä¿¡æ¯:', 'blue');
        console.log('  GitHub: https://github.com/your-repo/ai-dev-assistant');
        console.log('  æ–‡æ¡£: .ai-instructions.md');
        console.log('');
    }
}

// è¿è¡ŒCLI
if (require.main === module) {
    const cli = new AIDevCLI();
    cli.run().catch(error => {
        console.error('CLIæ‰§è¡Œå¤±è´¥:', error.message);
        process.exit(1);
    });
}

module.exports = AIDevCLI;
